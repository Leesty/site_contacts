{% extends "base.html" %}

{% block title %}Списки контактов — Партнёрка{% endblock %}

{% block content %}
  <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
    <h1 class="h4 mb-0">Списки контактов</h1>
    <a class="btn btn-outline-secondary btn-sm" href="{% url 'dashboard' %}">← В кабинет</a>
  </div>

  <p class="text-muted">
    Выберите тип базы, из которой хотите получить контакты.
    Лимит зависит от настроек базы и дополнительных лимитов менеджера.
  </p>

  {% if reason == 'already_got' %}
    <div class="alert alert-info mb-3 d-flex flex-wrap align-items-center gap-2">
      <span class="flex-grow-1">Вы уже получили максимум контактов из этой базы. Обратитесь к менеджеру за дополнительным лимитом.</span>
      <a class="btn btn-primary btn-sm" href="{% url 'request_contact_create' %}{% if selected_base %}?base_type={{ selected_base.pk }}{% endif %}">Обратиться</a>
    </div>
  {% elif reason == 'not_enough' %}
    <div class="alert alert-warning mb-3 d-flex flex-wrap align-items-center gap-2">
      <span class="flex-grow-1">К сожалению, в этой базе сейчас недостаточно свободных контактов. Обратитесь к менеджеру.</span>
      <a class="btn btn-primary btn-sm" href="{% url 'request_contact_create' %}{% if selected_base %}?base_type={{ selected_base.pk }}{% endif %}">Обратиться</a>
    </div>
  {% endif %}

  <form method="post" class="mb-4">
    {% csrf_token %}
    <div class="mb-3">
      {{ form.base_type.label_tag }}
      {{ form.base_type }}
      {% if form.base_type.errors %}
        <div class="text-danger small">
          {% for error in form.base_type.errors %}{{ error }}{% endfor %}
        </div>
      {% endif %}
    </div>
    <button type="submit" class="btn btn-primary">Получить контакты</button>
  </form>

  {% if allocated_contacts %}
    <h2 class="h5 mt-4">Выданные контакты</h2>
    <p class="mb-2">
      <a class="btn btn-outline-primary btn-sm" href="{% url 'download_my_contacts_txt' %}?base_type={{ selected_base.pk }}">Скачать .txt</a>
    </p>
    <ul class="list-group mt-2">
      {% for contact in allocated_contacts %}
        <li class="list-group-item">
          {{ contact.value }}
        </li>
      {% endfor %}
    </ul>
  {% endif %}

  {% if issued_by_base %}
    <h2 class="h5 mt-4">Скачать выданные контакты</h2>
    <p class="text-muted small">Скачайте ранее выданные контакты в виде .txt (по одному на строку). В файле — разбивка по дням выдачи.</p>
    <div class="d-flex flex-wrap gap-2 align-items-center mb-2">
      <a class="btn btn-outline-primary btn-sm" href="{% url 'download_my_contacts_txt' %}">Все базы</a>
      {% for base, count in issued_by_base %}
        <a class="btn btn-outline-primary btn-sm" href="{% url 'download_my_contacts_txt' %}?base_type={{ base.pk }}">{{ base.name }} ({{ count }})</a>
      {% endfor %}
    </div>
    <p class="text-muted small mb-1">Скачать контакты за конкретную дату:</p>
    <form action="{% url 'download_my_contacts_txt' %}" method="get" class="d-flex flex-wrap gap-2 align-items-center">
      <input type="date" name="date" class="form-control form-control-sm" style="width: auto;" required>
      <button type="submit" class="btn btn-outline-primary btn-sm">Скачать за дату</button>
    </form>
    <p class="text-muted small mt-1">Ссылка на скачивание действует только при входе в аккаунт. Если сохранили ссылку или открываете с другого устройства — сначала войдите на сайт, затем снова нажмите «Скачать».</p>
  {% endif %}
{% endblock %}

