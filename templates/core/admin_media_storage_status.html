{% extends "base.html" %}

{% block title %}Хранилище медиа (S3) — Партнёрка{% endblock %}

{% block content %}
  <div class="mb-3">
    <h1 class="h4 mb-1">Куда сохраняются фото и видео из отчётов</h1>
    <p class="text-muted small mb-0">
      Диагностика: используется ли облачное хранилище S3 или что-то мешает.
    </p>
  </div>

  <div class="card shadow-sm">
    <div class="card-body">
      {% if diag.source == "env" %}
        <p class="mb-2"><strong>Сейчас используется S3 из переменных окружения</strong> (<code>USE_S3_MEDIA=1</code>). Все медиа пишутся в бакет в папку <code>media/</code> (внутри: <code>media/leads/user_5/...</code> и т.д.).</p>
        <p class="mb-1">Бакет: <code>{{ diag.bucket|default:"— не задан" }}</code></p>
        <p class="mb-0">Endpoint: <code>{{ diag.endpoint|default:"— по умолчанию" }}</code></p>
        <form method="post" action="" class="mt-2 mb-2">
          {% csrf_token %}
          <input type="hidden" name="action" value="test_write">
          <button type="submit" class="btn btn-primary btn-sm">Проверить запись в S3</button>
        </form>
        {% if write_result and diag.source == "env" %}
          {% if write_result.ok %}
            <div class="alert alert-success py-2 mb-2">{{ write_result.message }}</div>
          {% else %}
            <div class="alert alert-danger py-2 mb-2"><strong>Ошибка:</strong> {{ write_result.message }}{% if write_result.detail %}<pre class="small mt-2 mb-0">{{ write_result.detail }}</pre>{% endif %}</div>
          {% endif %}
        {% endif %}
        <p class="text-muted small mb-0">
          Если в панели S3 у вас другой бакет (например 06dcf8ea-...), то либо задайте в env тот же <code>AWS_STORAGE_BUCKET_NAME</code>, либо уберите <code>USE_S3_MEDIA</code> и настройте S3 в админке (Core → Настройки хранилища медиа).
        </p>
      {% elif diag.source == "db" and not diag.error %}
        <p class="mb-2 text-success"><strong>S3 из админки подключается.</strong></p>
        <p class="mb-1">Бакет: <code>{{ diag.bucket }}</code></p>
        <p class="mb-0">Endpoint: <code>{{ diag.endpoint }}</code></p>
        <p class="mt-2 mb-2">
          <strong>Проверка записи:</strong> нажмите кнопку — в хранилище будет записан тестовый файл и сразу удалён (тот же путь, что при загрузке отчётов).
        </p>
        <form method="post" action="" class="mb-3">
          {% csrf_token %}
          <input type="hidden" name="action" value="test_write">
          <button type="submit" class="btn btn-primary btn-sm">Проверить запись в S3</button>
        </form>
        {% if write_result %}
          {% if write_result.ok %}
            <div class="alert alert-success py-2 mb-2">{{ write_result.message }}</div>
          {% else %}
            <div class="alert alert-danger py-2 mb-2">
              <strong>Ошибка при записи:</strong><br>{{ write_result.message }}
              {% if write_result.detail %}
                <pre class="small mt-2 mb-0 text-start" style="white-space:pre-wrap;font-size:0.75rem;">{{ write_result.detail }}</pre>
              {% endif %}
            </div>
          {% endif %}
        {% endif %}
        <p class="text-muted small mb-0">
          Если запись прошла успешно, но в панели 0 ГБ — подождите минуту (счётчик может обновляться с задержкой) или откройте вкладку «Объекты» в бакете. Если при нажатии кнопки выше видите ошибку — именно она мешает и загрузкам отчётов.
        </p>
      {% elif diag.source == "db" and diag.error %}
        <p class="mb-2 text-danger"><strong>Ошибка подключения к S3</strong></p>
        <p class="mb-1">Бакет в настройках: <code>{{ diag.bucket }}</code>, endpoint: <code>{{ diag.endpoint }}</code></p>
        <p class="mb-0">Ошибка: <code>{{ diag.error }}</code></p>
        <p class="mt-2 text-muted small">
          Проверьте в админке (Core → Настройки хранилища медиа): Access Key, Secret Key и Endpoint URL (для Timeweb: <code>https://s3.twcstorage.ru</code> или <code>https://s3.timeweb.cloud</code>). После исправления пересохраните настройки и перезапустите приложение.
        </p>
      {% else %}
        <p class="mb-0 text-warning">{{ diag.error|default:"S3 не настроен." }}</p>
      {% endif %}
      <p class="mt-3 mb-0">
        <a href="{% url 'dashboard' %}">← В кабинет</a>
      </p>
    </div>
  </div>
{% endblock %}
