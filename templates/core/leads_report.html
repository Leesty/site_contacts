{% extends "base.html" %}

{% block title %}Отчёт по лидам — Партнёрка{% endblock %}

{% block content %}
  <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
    <h1 class="h4 mb-0">Отчёт по лидам</h1>
    <a class="btn btn-outline-secondary btn-sm" href="{% url 'dashboard' %}">← В кабинет</a>
  </div>

  <style>
    .leads-report-form .field-contact-link .form-label { display: block; width: 100%; margin-bottom: 0.35rem; }
    .leads-report-form .field-contact-link .form-control-wrap { display: block; width: 100%; margin-top: 0.25rem; }
    .leads-report-form .field-contact-link input[name="raw_contact"] {
      display: block !important;
      width: 100% !important;
      background-color: rgba(15, 23, 42, 0.95) !important;
      border: 1px solid rgba(55, 65, 81, 0.9) !important;
      color: #e5e7eb !important;
      border-radius: 0.5rem;
      padding: 0.375rem 0.75rem;
    }
    .leads-report-form .field-contact-link input[name="raw_contact"]:focus {
      background-color: rgba(15, 23, 42, 1) !important;
      border-color: #22c55e !important;
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.75);
      color: #e5f4ec !important;
    }
    .leads-report-form .field-contact-link input[name="raw_contact"]::placeholder {
      color: rgba(148, 163, 184, 0.8);
    }
    .leads-report-form .field-contact-link input[name="raw_contact"]:-webkit-autofill,
    .leads-report-form .field-contact-link input[name="raw_contact"]:-webkit-autofill:hover,
    .leads-report-form .field-contact-link input[name="raw_contact"]:-webkit-autofill:focus {
      -webkit-text-fill-color: #e5e7eb !important;
      -webkit-box-shadow: 0 0 0 1000px rgba(15, 23, 42, 0.95) inset !important;
      box-shadow: 0 0 0 1000px rgba(15, 23, 42, 0.95) inset !important;
    }
  </style>

  <p class="text-muted">
    Заполните форму: укажите контакт или ссылку, выберите категорию лида и загрузите скриншот или запись экрана (видео).
    Максимальный размер файла — 30 МБ. Сайт разрешит отправить отчёт только после выбора подходящего файла.
    Все лиды проверяются модераторами. Если возникли вопросы — пишите в поддержку.
  </p>

  {% if messages %}
    {% for message in messages %}
      <div class="alert py-2 mb-3 {% if message.tags == 'error' %}alert-danger{% else %}alert-success{% endif %}" role="alert">{{ message }}</div>
    {% endfor %}
  {% endif %}

  <form method="post" enctype="multipart/form-data" class="mt-3 leads-report-form">
    {% csrf_token %}

    <div class="mb-3">
      <label class="form-label" for="{{ form.lead_type.id_for_label }}">{{ form.lead_type.label }}</label>
      {{ form.lead_type }}
      {% if form.lead_type.help_text %}
        <div class="form-text">{{ form.lead_type.help_text }}</div>
      {% endif %}
      {% if form.lead_type.errors %}
        <div class="text-danger small">{% for error in form.lead_type.errors %}{{ error }}{% endfor %}</div>
      {% endif %}
    </div>

    <div class="mb-3">
      <label class="form-label" for="{{ form.lead_date.id_for_label }}">{{ form.lead_date.label }}</label>
      {{ form.lead_date }}
      {% if form.lead_date.help_text %}
        <div class="form-text">{{ form.lead_date.help_text }}</div>
      {% endif %}
      {% if form.lead_date.errors %}
        <div class="text-danger small">{% for error in form.lead_date.errors %}{{ error }}{% endfor %}</div>
      {% endif %}
    </div>

    <div class="mb-3 field-contact-link">
      <label class="form-label" for="{{ form.raw_contact.id_for_label }}">{{ form.raw_contact.label }}</label>
      <div class="form-control-wrap">
        {{ form.raw_contact }}
      </div>
      {% if form.raw_contact.help_text %}
        <div class="form-text">{{ form.raw_contact.help_text }}</div>
      {% endif %}
      {% if form.raw_contact.errors %}
        <div class="text-danger small">{% for error in form.raw_contact.errors %}{{ error }}{% endfor %}</div>
      {% endif %}
    </div>

    <div class="mb-3" id="lead-attachment-wrap">
      <label class="form-label" for="{{ form.attachment.id_for_label }}">{{ form.attachment.label }}</label>
      {{ form.attachment }}
      {% if form.attachment.help_text %}
        <div class="form-text">{{ form.attachment.help_text }}</div>
      {% endif %}
      <div id="lead-attachment-status" class="small mt-1" aria-live="polite"></div>
      {% if form.attachment.errors %}
        <div class="text-danger small">{% for error in form.attachment.errors %}{{ error }}{% endfor %}</div>
      {% endif %}
    </div>

    <div class="mb-3">
      <label class="form-label" for="{{ form.comment.id_for_label }}">{{ form.comment.label }}</label>
      {{ form.comment }}
      {% if form.comment.help_text %}
        <div class="form-text">{{ form.comment.help_text }}</div>
      {% endif %}
      {% if form.comment.errors %}
        <div class="text-danger small">{% for error in form.comment.errors %}{{ error }}{% endfor %}</div>
      {% endif %}
    </div>

    {% if form.non_field_errors %}
      <div class="alert alert-danger py-2 mb-3">
        {% for error in form.non_field_errors %}<div>{{ error }}</div>{% endfor %}
      </div>
    {% endif %}

    <button type="submit" class="btn btn-primary" id="lead-report-submit" disabled>Отправить отчёт</button>
  </form>

  <script>
  (function() {
    var MAX_SIZE = 30 * 1024 * 1024;
    var ALLOWED_EXT = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'bmp', 'heic', 'mp4', 'mov', 'webm', 'm4v', '3gp'];
    var form = document.querySelector('.leads-report-form');
    var input = document.getElementById('id_attachment');
    var dateInput = document.getElementById('id_lead_date');
    var statusEl = document.getElementById('lead-attachment-status');
    var submitBtn = document.getElementById('lead-report-submit');

    function formatSize(bytes) {
      if (bytes >= 1024 * 1024) return (bytes / (1024 * 1024)).toFixed(1) + ' МБ';
      return (bytes / 1024).toFixed(0) + ' КБ';
    }

    function setStatus(msg, isError) {
      statusEl.textContent = msg;
      statusEl.className = 'small mt-1 ' + (isError ? 'text-danger' : 'text-success');
    }

    function hasValidDate() {
      if (!dateInput || !dateInput.value || !dateInput.value.trim()) return false;
      return true;
    }

    function checkFile() {
      if (!hasValidDate()) {
        submitBtn.disabled = true;
        if (statusEl) setStatus('Выберите дату лида и приложите скриншот или видео.', false);
        return;
      }
      var files = input && input.files;
      if (!files || !files.length) {
        submitBtn.disabled = true;
        setStatus('Выберите скриншот или видео — после проверки файла кнопка «Отправить отчёт» станет активной.', false);
        return;
      }
      var file = files[0];
      var ext = (file.name || '').split('.').pop().toLowerCase();
      if (ALLOWED_EXT.indexOf(ext) === -1) {
        submitBtn.disabled = true;
        setStatus('Разрешены только изображения и видео (jpg, png, gif, webp, mp4, mov и т.д.). Выберите другой файл.', true);
        return;
      }
      if (file.size > MAX_SIZE) {
        submitBtn.disabled = true;
        setStatus('Файл слишком большой (' + formatSize(file.size) + '). Максимум 30 МБ. Сожмите видео или приложите скриншот.', true);
        return;
      }
      submitBtn.disabled = false;
      setStatus('Файл выбран: ' + file.name + ' (' + formatSize(file.size) + '). Можно отправить отчёт.', false);
    }

    if (input) {
      input.addEventListener('change', checkFile);
    }
    if (dateInput) {
      dateInput.addEventListener('change', checkFile);
      dateInput.addEventListener('input', checkFile);
    }
    checkFile();
    if (!input) {
      submitBtn.disabled = !hasValidDate();
    }

    if (form) {
      form.addEventListener('submit', function() {
        submitBtn.disabled = true;
        submitBtn.textContent = 'Отправка…';
      });
    }
  })();
  </script>
{% endblock %}
