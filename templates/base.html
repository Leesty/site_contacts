{% load static %}
<!doctype html>
<html lang="ru">
  <head>
    <meta charset="utf-8">
    <title>{% block title %}Партнёрка{% endblock %}</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap 5 -->
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    >
    <link rel="stylesheet" href="{% static 'css/main.css' %}">
  </head>
  <body {% block body_attrs %}{% endblock %}>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4 py-2">
      <div class="container">
        <a class="navbar-brand fw-bold" href="{% url 'index' %}">Партнёрка</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarMain">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarMain">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            {% if user.is_authenticated %}
              <li class="nav-item">
                <a class="nav-link" href="{% url 'dashboard' %}">Кабинет</a>
              </li>
              {% if not user.is_staff and not user.is_superuser and user.role != 'support' and user.role != 'admin' %}
              <li class="nav-item">
                <a class="nav-link" href="{% url 'contacts' %}">Списки контактов</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="{% url 'leads_report' %}">Отчёт по лидам</a>
              </li>
              <li class="nav-item">
                <a class="nav-link" href="{% url 'leads_stats' %}">Статистика лидов</a>
              </li>
              {% endif %}
            {% endif %}
          </ul>
          <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
            {% if user.is_authenticated %}
              {% if not user.is_staff and not user.is_superuser and user.role != 'support' and user.role != 'admin' %}
              <li class="nav-item align-self-center dropdown">
                <a class="nav-link position-relative py-1 px-2 {% if rework_leads_count %}text-warning{% else %}text-white-50{% endif %}" href="#" id="navbarReworkDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false" title="Уведомления">
                  <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="currentColor" viewBox="0 0 16 16"><path d="M8 16a2 2 0 0 0 2-2H6a2 2 0 0 0 2 2zM8 1.918l-.797.161A4.002 4.002 0 0 0 4 6c0 .628.134 2.197.459 3.742.16.767.376 1.566.663 2.258h10.244c.287-.692.502-1.49.663-2.258C13.866 8.197 14 6.628 14 6a4.002 4.002 0 0 0-3.203-3.92L8 1.917z"/></svg>
                  <span id="navbar-rework-badge" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" style="{% if not rework_leads_count %}display:none;{% endif %}">{{ rework_leads_count|default:0 }}</span>
                </a>
                <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarReworkDropdown" id="navbar-rework-dropdown-menu">
                  <li><span class="dropdown-item-text small" id="navbar-rework-text">{% if rework_leads_count %}У вас {{ rework_leads_count }} отчёт(ов) на доработке. Зайдите в «Мои лиды», доработайте и отправьте заново.{% else %}Нет уведомлений{% endif %}</span></li>
                  {% if rework_leads_count %}<li><hr class="dropdown-divider"></li><li><a class="dropdown-item" href="{% url 'leads_my_list' %}">Мои лиды →</a></li>{% endif %}
                </ul>
              </li>
              {% endif %}
              <li class="nav-item me-2 text-white-50 align-self-center">
                {{ user.username }}
                {% if user.status == 'approved' %}
                  <span id="navbar-balance" class="badge bg-primary ms-2">Баланс: {{ user.balance|default:0 }} руб.</span>
                {% endif %}
                {% if user.status != 'approved' %}
                  <span class="badge bg-warning text-dark ms-2">На модерации</span>
                {% endif %}
              </li>
              <li class="nav-item">
                <a class="btn btn-outline-light btn-sm" href="{% url 'logout' %}">Выйти</a>
              </li>
            {% else %}
              <li class="nav-item me-2">
                <a class="btn btn-outline-light btn-sm" href="{% url 'login' %}">Войти</a>
              </li>
              <li class="nav-item">
                <a class="btn btn-warning btn-sm" href="{% url 'register' %}">Регистрация</a>
              </li>
            {% endif %}
          </ul>
        </div>
      </div>
    </nav>

    <div class="app-shell d-flex flex-column">
      <main class="container mb-5">
        {% if messages %}
          <div class="mb-3">
            {% for message in messages %}
              <div class="alert alert-{{ message.tags }} mb-2" role="alert">
                {{ message|linebreaksbr }}
              </div>
            {% endfor %}
          </div>
        {% endif %}
        {% block content %}{% endblock %}
      </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz"
            crossorigin="anonymous"></script>
    {% if user.is_authenticated %}
      <script>
        (function() {
          var updatesUrl = '{% url "account_updates_api" %}';
          var leadsUpdatedAt = '{{ leads_updated_at|default:""|escapejs }}';
          window.threadUpdatedAt = '{{ thread_updated_at|default:""|escapejs }}';
          var adminThreadsUpdatedAt = document.body.getAttribute('data-admin-threads-updated-at') || '';
          var pollInterval = 20000; // 20 сек

          function isSupportPanelOpen() {
            var panel = document.getElementById('support-panel');
            return panel && !panel.classList.contains('d-none');
          }

          function poll() {
            fetch(updatesUrl, { credentials: 'same-origin', headers: { 'Accept': 'application/json' } })
              .then(function(r) { return r.json(); })
              .then(function(data) {
                var badge = document.getElementById('support-unread-badge');
                if (badge) {
                  badge.style.display = data.support_has_unread ? '' : 'none';
                }
                var balanceEl = document.getElementById('navbar-balance');
                if (balanceEl) {
                  balanceEl.textContent = 'Баланс: ' + (data.balance || 0) + ' руб.';
                }
                if (leadsUpdatedAt !== '' && data.leads_updated_at && data.leads_updated_at !== leadsUpdatedAt) {
                  location.reload();
                }
                if (window.threadUpdatedAt !== '' && data.thread_updated_at && data.thread_updated_at !== window.threadUpdatedAt) {
                  if (!isSupportPanelOpen()) {
                    location.reload();
                  } else {
                    window.threadUpdatedAt = data.thread_updated_at;
                  }
                }
                if (adminThreadsUpdatedAt !== '' && data.admin && data.admin.threads_updated_at && data.admin.threads_updated_at !== adminThreadsUpdatedAt) {
                  location.reload();
                }
                if (data.admin) {
                  var a = data.admin;
                  var el = document.getElementById('admin-unread-threads');
                  if (el) {
                    el.textContent = a.unread_threads_count || 0;
                    el.style.display = (a.unread_threads_count && a.unread_threads_count > 0) ? '' : 'none';
                  }
                  el = document.getElementById('admin-pending-requests');
                  if (el) {
                    el.textContent = a.pending_requests_count || 0;
                    el.style.display = (a.pending_requests_count && a.pending_requests_count > 0) ? '' : 'none';
                  }
                  el = document.getElementById('admin-contact-requests');
                  if (el) {
                    el.textContent = a.contact_requests_pending_count || 0;
                    el.style.display = (a.contact_requests_pending_count && a.contact_requests_pending_count > 0) ? '' : 'none';
                  }
                  el = document.getElementById('admin-withdrawal-requests');
                  if (el) {
                    el.textContent = a.withdrawal_requests_pending_count || 0;
                    el.style.display = (a.withdrawal_requests_pending_count && a.withdrawal_requests_pending_count > 0) ? '' : 'none';
                  }
                  el = document.getElementById('admin-pending-leads');
                  if (el) {
                    el.textContent = a.pending_leads_count || 0;
                    el.style.display = (a.pending_leads_count && a.pending_leads_count > 0) ? '' : 'none';
                  }
                }
                var reworkBadge = document.getElementById('navbar-rework-badge');
                if (reworkBadge && typeof data.rework_leads_count !== 'undefined') {
                  var c = data.rework_leads_count || 0;
                  reworkBadge.textContent = c;
                  reworkBadge.style.display = c > 0 ? '' : 'none';
                }
              })
              .catch(function() {});
          }

          setInterval(poll, pollInterval);
          // первый запрос через 5 сек, чтобы не нагружать сразу после загрузки
          setTimeout(poll, 5000);
        })();
      </script>
    {% endif %}
  </body>
</html>

