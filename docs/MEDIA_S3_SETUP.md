# Хранение медиафайлов в S3 (чтобы не терялись при редеплое)

После редеплоя папка `media/` на диске создаётся заново, поэтому загруженные фото и видео пропадают. Настройте S3 — вложения будут сохраняться в облако.

## Рекомендуется: S3 напрямую из .env (в коде)

Подключение задаётся при старте приложения из переменных окружения. Никакой админки и БД — один раз прописали в `.env`, перезапустили, всё идёт в бакет.

1. В панели Timeweb (или другого провайдера) откройте ваш бакет, скопируйте:
   - **S3 URL** (Endpoint), например `https://s3.twcstorage.ru`
   - **Название бакета** (Bucket name), например `06dcf8ea-173b-4c64-bfdf-bee5297b1c71`
   - **Access Key** и **Secret Key** (ключи доступа S3)
2. В проекте откройте файл `.env` (скопируйте из `.env.example`, если его ещё нет).
3. Добавьте или раскомментируйте строки:

```env
USE_S3_MEDIA=1
AWS_ACCESS_KEY_ID=ваш_access_key_из_панели
AWS_SECRET_ACCESS_KEY=ваш_secret_key_из_панели
AWS_STORAGE_BUCKET_NAME=06dcf8ea-173b-4c64-bfdf-bee5297b1c71
AWS_S3_ENDPOINT_URL=https://s3.twcstorage.ru
AWS_S3_REGION_NAME=ru-1
```

4. Сохраните `.env`, перезапустите приложение (редеплой или перезапуск gunicorn/uwsgi).
5. Загрузите тестовый отчёт с фото — файл должен появиться в бакете (вкладка «Объекты» в панели S3).

При `USE_S3_MEDIA=1` настройки S3 из админки Django не используются — только переменные окружения.

## Вариант 2: через админку (настройки в БД)

Если не хотите хранить ключи в .env, можно настроить S3 в админке Django: Core → «Настройки хранилища медиа (S3)» — включить и заполнить бакет, Access Key, Secret Key, Endpoint URL. Тогда в .env не задавайте `USE_S3_MEDIA=1`.

## Проверка, что файлы попадают в S3

На сервере выполните:

```bash
python manage.py test_media_storage
```

Команда сохранит тестовый файл и покажет, куда он попал (в S3 или локально). Если в логах приложения при загрузке отчёта видно **«Media storage: сохранение локально»** или **«не удалось подключиться к S3»** — проверьте в админке ключи и Endpoint URL (для Timeweb часто `https://s3.twcstorage.ru` или `https://s3.timeweb.cloud`), пересохраните настройки S3 и перезапустите приложение.

## Другие провайдеры (AWS, Selectel, MinIO и т.д.)

- Укажите `USE_S3_MEDIA=1` и те же переменные.
- Для **AWS** можно не задавать `AWS_S3_ENDPOINT_URL` (будет использоваться стандартный endpoint AWS).
- Для **Selectel** и других S3-совместимых сервисов задайте их endpoint в `AWS_S3_ENDPOINT_URL`.

## Локальная разработка

Не задавайте `USE_S3_MEDIA` и не включайте S3 в админке — файлы будут сохраняться в каталог `media/` на диске, как раньше.
