# Хранение медиафайлов в S3 (чтобы не терялись при редеплое)

После редеплоя на облачном хостинге папка `media/` на диске создаётся заново, поэтому загруженные фото и видео пропадают. Чтобы вложения лидов сохранялись между деплоями, настройте S3-совместимое хранилище.

## Вариант 1: настройка прямо на сайте (без переменных окружения)

1. В панели Timeweb Cloud создайте **объектное хранилище S3** и бакет, получите **Access Key** и **Secret Key**, узнайте **Endpoint URL**. В панели может быть указан `https://s3.twcstorage.ru` или `https://s3.timeweb.cloud` — используйте тот, что показан в настройках бакета (S3 URL).
2. На вашем сайте зайдите в **админку Django** (`/admin/`).
3. Откройте **«Настройки хранилища медиа (S3)»** (в разделе CORE).
4. Нажмите **«Добавить»** (если запись ещё нет), заполните:
   - **Включить** (enabled) — поставьте галочку.
   - **Имя бакета** — имя созданного бакета.
   - **Access Key ID** и **Secret Access Key** — ключи из Timeweb.
   - **Endpoint URL** — например `https://s3.timeweb.cloud`.
   - **Region** — при необходимости (например `ru-1`).
5. Сохраните. Новые загрузки начнут сохраняться в S3, редеплой их не затронет.

Переменные окружения при этом задавать не нужно.

## Вариант 2: через переменные окружения (Timeweb Cloud)

1. В панели Timeweb Cloud создайте **объектное хранилище S3** (раздел «Хранилища» / S3).
2. Создайте бакет (например `partnerka-media`).
3. Получите **Access Key** и **Secret Key** (ключи доступа S3).
4. Узнайте **Endpoint URL** для S3 (в документации Timeweb или в настройках бакета), например:  
   `https://s3.timeweb.cloud` или `https://s3.ru-1.timeweb.cloud`.

Добавьте в переменные окружения (на сервере или в настройках деплоя Timeweb):

```env
USE_S3_MEDIA=1
AWS_ACCESS_KEY_ID=ваш_access_key
AWS_SECRET_ACCESS_KEY=ваш_secret_key
AWS_STORAGE_BUCKET_NAME=partnerka-media
AWS_S3_REGION_NAME=ru-1
AWS_S3_ENDPOINT_URL=https://s3.timeweb.cloud
```

(Значения `AWS_S3_REGION_NAME` и `AWS_S3_ENDPOINT_URL` уточните в документации Timeweb для вашего региона.)

5. Пересоберите/задеплойте приложение и выполните:

```bash
pip install -r requirements.txt
```

После этого новые загрузки будут сохраняться в S3 и не пропадут при редеплое. Старые файлы, уже потерянные с диска, вернуть нельзя — только новые.

## Проверка, что файлы попадают в S3

На сервере выполните:

```bash
python manage.py test_media_storage
```

Команда сохранит тестовый файл и покажет, куда он попал (в S3 или локально). Если в логах приложения при загрузке отчёта видно **«Media storage: сохранение локально»** или **«не удалось подключиться к S3»** — проверьте в админке ключи и Endpoint URL (для Timeweb часто `https://s3.twcstorage.ru` или `https://s3.timeweb.cloud`), пересохраните настройки S3 и перезапустите приложение.

## Другие провайдеры (AWS, Selectel, MinIO и т.д.)

- Укажите `USE_S3_MEDIA=1` и те же переменные.
- Для **AWS** можно не задавать `AWS_S3_ENDPOINT_URL` (будет использоваться стандартный endpoint AWS).
- Для **Selectel** и других S3-совместимых сервисов задайте их endpoint в `AWS_S3_ENDPOINT_URL`.

## Локальная разработка

Не задавайте `USE_S3_MEDIA` и не включайте S3 в админке — файлы будут сохраняться в каталог `media/` на диске, как раньше.
